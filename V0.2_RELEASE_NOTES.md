# AgentOAuth v0.2 Release Notes

## üéâ What's New in v0.2

### Major Features

#### 1. Token Revocation

Tokens can now be revoked using their unique `jti` (JWT ID):

```bash
# Revoke a token
curl -X POST http://localhost:3000/revoke \
  -H "Content-Type: application/json" \
  -d '{"jti": "550e8400-e29b-41d4-a716-446655440000"}'

# Response
{
  "success": true,
  "jti": "550e8400-...",
  "revokedAt": "2025-10-21T12:34:56.789Z"
}
```

Revoked tokens fail verification with `code: REVOKED`.

#### 2. Anti-Replay Protection

Tokens can only be used once. The second use is detected as a replay attack:

```javascript
// First verification
const result1 = await verify(token, jwksUrl);
// { valid: true, ... }

// Second verification with same token
const result2 = await verify(token, jwksUrl);
// { valid: false, error: "Token replay detected", code: "REPLAY" }
```

#### 3. JWT ID (jti) Field

All tokens now include a unique `jti` field:

```json
{
  "ver": "0.2",
  "jti": "550e8400-e29b-41d4-a716-446655440000",  // NEW!
  "user": "did:example:alice",
  ...
}
```

**Auto-generation:** If you don't provide a `jti`, the SDK automatically generates a UUID.

#### 4. Examples Package

New example scripts:

```bash
cd packages/examples

# Create a token
node issue-token.js

# Verify a token
node verify-token.js
```

#### 5. Postman Collection

Complete API collection in `postman/AgentOAuth-v0.2.postman_collection.json`:
- Verify token
- Revoke token
- Create demo token
- Get JWKS
- Health check

Import into Postman or Insomnia for easy testing!

#### 6. Enhanced Playground

The interactive playground now has:
- ‚úÖ **Copy buttons** - Copy token, header, or payload with one click
- ‚úÖ **Sample dropdown** - Load pre-configured example tokens
- ‚úÖ **Revoke button** - Revoke tokens directly from the UI
- ‚úÖ **JTI display** - See the unique token ID
- ‚úÖ **Pretty-printed JSON** - Easier to read

Try it: http://localhost:8080 (after starting the playground)

#### 7. 5-Minute Quickstart

Complete walkthrough in the README showing:
1. Setup
2. Generate keys & issue token
3. Verify token
4. Revoke token
5. Re-verify (fails with REVOKED)

---

## üì¶ Package Updates

### SDK (`@agentoauth/sdk@0.2.0`)

**New:**
- `jti` auto-generation in `request()`
- Support for `ver: '0.2'`
- New error codes: `REVOKED`, `REPLAY`

**Breaking Changes:**
- Payload type now requires `jti` field
- `ver` must be `'0.2'` (not `'0.1'`)

**Migration:**
```typescript
// v0.1
const payload = {
  ver: '0.1',
  user: '...',
  // ...
};

// v0.2
const payload = {
  ver: '0.2',
  jti: crypto.randomUUID(), // or omit - auto-generated
  user: '...',
  // ...
};
```

### Verifier API (`@agentoauth/verifier-api@0.2.0`)

**New:**
- `POST /revoke` - Revoke tokens by jti
- Revocation list (in-memory)
- Replay cache (in-memory)
- Health endpoint shows revocation stats

**Changes:**
- `/verify` now checks revocation and replay
- Version updated to 0.2.0
- Enhanced logging with jti

### Playground (`@agentoauth/playground@0.2.0`)

**New:**
- Copy buttons for token/header/payload
- Sample token dropdown
- Revoke token button
- JTI display in results
- Enhanced UI

---

## üîê Security Improvements

### Revocation

Compromised tokens can be immediately invalidated:

```javascript
// If a token is stolen
revokeToken(jti);

// Further verification attempts fail
// { valid: false, code: 'REVOKED' }
```

### Replay Protection

Tokens can only be used once:

```javascript
// First use: OK
verify(token) // { valid: true }

// Second use: BLOCKED
verify(token) // { valid: false, code: 'REPLAY' }
```

### Audit Trail

All revocations and replays are logged:

```
üö´ Token revoked: 550e8400-e29b-41d4-a716-446655440000
üö® REPLAY ATTACK detected: { jti: '...', tokenHash: '...' }
```

---

## üìä New Statistics

The `/health` endpoint now shows:

```json
{
  "status": "ok",
  "version": "0.2.0",
  "revoked": 5,        // Number of revoked tokens
  "replayCache": 42    // Number of tokens in replay cache
}
```

---

## üß™ Testing

**New tests (19 total, +3 from v0.1):**

```
‚úì jti auto-generation (new)
‚úì jti usage with provided value (new)
‚úì jti included in token (new)
```

---

## üìö New Documentation

- **CHANGELOG.md** - Version history
- **packages/examples/README.md** - Example scripts guide
- **postman/README.md** - Postman collection guide
- **V0.2_RELEASE_NOTES.md** - This file

---

## üîÑ Migration Guide

### From v0.1 to v0.2

**Payload changes:**

```typescript
// Add jti to all payloads
const payload = {
  ver: '0.2',              // Changed from '0.1'
  jti: crypto.randomUUID(), // NEW (or let SDK auto-generate)
  user: 'did:example:alice',
  agent: 'bot',
  scope: 'pay:merchant',
  limit: { amount: 1000, currency: 'USD' },
  exp: Math.floor(Date.now() / 1000) + 3600,
  nonce: crypto.randomUUID()
};
```

**Backward compatibility:**

The verifier API accepts both v0.1 and v0.2 tokens:
- v0.1 tokens: No revocation/replay checks (jti missing)
- v0.2 tokens: Full revocation/replay protection

---

## üéØ Use Cases

### Revocation

**Scenario:** User's device is stolen

```javascript
// 1. User reports theft
// 2. Revoke all active tokens
revokeToken(jti1);
revokeToken(jti2);

// 3. Stolen tokens are now invalid
// Attacker can't use them!
```

### Replay Protection

**Scenario:** Attacker intercepts a payment token

```javascript
// 1. Legitimate use
agent.pay(150, token);  // ‚úÖ Success

// 2. Attacker tries to reuse
attacker.pay(150, token); // ‚ùå REPLAY detected!
```

---

## üìñ Learn More

- [CHANGELOG.md](CHANGELOG.md) - Complete change history
- [SPEC.md](packages/spec/SPEC.md) - Updated specification
- [Examples](packages/examples/) - Code examples
- [Postman Collection](postman/) - API testing collection

---

## üéä Summary

AgentOAuth v0.2 adds critical security features:

‚úÖ **Revocation** - Invalidate compromised tokens  
‚úÖ **Anti-Replay** - Prevent token reuse  
‚úÖ **JWT ID (jti)** - Unique token identification  
‚úÖ **Examples** - Easy-to-use sample scripts  
‚úÖ **Postman** - API testing collection  
‚úÖ **Enhanced Playground** - Better UX with copy buttons  

**19 tests passing. Production ready. Open source (MIT/Apache 2.0).**

Upgrade today: `pnpm setup && pnpm demo`

