name = "agentoauth-verifier"
main = "src/index.ts"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

# Development environment
[env.development]
name = "agentoauth-verifier-dev"
assets = { directory = "./public", binding = "ASSETS" }

# KV namespace for development (create with: wrangler kv namespace create RATE_LIMIT_KV)
[[env.development.kv_namespaces]]
binding = "RATE_LIMIT_KV" 
id = "3a4e0e4638394578b8a432f90a719741"  # Preview KV namespace ID

# Durable Objects for development
[env.development.durable_objects]
bindings = [
  { name = "POLICY_STATE", class_name = "PolicyState" }
]

[[env.development.migrations]]
tag = "v1"
new_classes = ["PolicyState"]

# Production environment
[env.production]
name = "agentoauth-verifier-prod"
compatibility_flags = ["nodejs_compat"]
assets = { directory = "./public", binding = "ASSETS" }

# Custom domain routing (update with your actual zone_name)
[[env.production.routes]]
pattern = "verifier.agentoauth.org/*"
zone_name = "agentoauth.org"

# KV namespace for rate limiting (create with: wrangler kv namespace create RATE_LIMIT_KV)
[[env.production.kv_namespaces]]
binding = "RATE_LIMIT_KV" 
id = "5c58aa1e80594bd6b815f5dcb53eb8f7" # Replace with actual KV namespace ID
preview_id = "3a4e0e4638394578b8a432f90a719741"  # Replace with actual preview KV namespace ID

# R2 bucket for audit logs (create with: wrangler r2 bucket create agentoauth-audit-logs)
[[env.production.r2_buckets]]
binding = "AUDIT_LOGS_R2"
bucket_name = "agentoauth-audit-logs"

# Durable Objects
[env.production.durable_objects]
bindings = [
  { name = "POLICY_STATE", class_name = "PolicyState" }
]

# Durable Object migrations
[[env.production.migrations]]
tag = "v1"
new_classes = ["PolicyState"]

# Environment variables
[env.production.vars]
ENVIRONMENT = "production"

# Secrets to set with wrangler secret put:
# - API_KEY_PUBLIC_KEY: JSON string of the EdDSA public key for API key verification
# - AUDIT_SALT: Random string for hashing PII in audit logs
# - SIGNING_PRIVATE_KEY: JWK for signing receipts
# - SIGNING_KID: Key ID for receipt signing

# Example commands to set secrets:
# wrangler secret put API_KEY_PUBLIC_KEY --env production
# wrangler secret put AUDIT_SALT --env production
# wrangler secret put SIGNING_PRIVATE_KEY --env production
# wrangler secret put SIGNING_KID --env production
